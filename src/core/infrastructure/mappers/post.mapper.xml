<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="PostMapper">

<select id="findFeedPosts">
    SELECT
        p.*,
        t.id as tag_id,
        t.name as tag_name,
        c.id as comment_id,
        p.content as comment_content,
        af.fileKey,
        af.fileMetadata
    FROM posts p
        LEFT JOIN post_tags pt ON p.id = pt.post_id
        LEFT JOIN tags t ON pt.tag_id = t.id
        LEFT JOIN comments c ON p.id = c.post_id
        LEFT JOIN (
            <include refid="attachmentFilesQuery"/>
            WHERE a.record_type = 'post'
                AND a.record_id = p.id
                AND a.name = 'thumbnail'
        ) af ON 1=1
    WHERE p.is_published_yn = 'Y'
        AND p.post_type = 'post'
    ORDER BY p.published_at DESC
    LIMIT #{limit, jdbcType=INTEGER}
</select>

<!-- 첨부파일만 별도로 조회하는 쿼리 -->
<select id="findAttachmentFiles">
    <include refid="CommonMapper.attachmentFilesQuery"/>
    WHERE a.record_type = #{recordType}
        AND a.record_id = #{recordId}
        <if test="attachmentName != null">
            AND a.name = #{attachmentName}
        </if>
</select>

</mapper>