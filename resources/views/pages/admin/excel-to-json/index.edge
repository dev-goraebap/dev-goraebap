<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel to JSON ë³€í™˜ê¸°</title>
    <script src="https://unpkg.com/@hotwired/stimulus/dist/stimulus.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            background-color: #f8fafc;
        }
        
        .upload-area {
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
            padding: 3rem;
            text-align: center;
            background-color: #f1f5f9;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .upload-area:hover {
            border-color: #3b82f6;
            background-color: #e0f2fe;
        }
        
        .upload-area.dragover {
            border-color: #3b82f6;
            background-color: #dbeafe;
        }
        
        .file-input {
            display: none;
        }
        
        .btn {
            background-color: #3b82f6;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            margin: 0.5rem;
            transition: background-color 0.2s;
        }
        
        .btn:hover {
            background-color: #2563eb;
        }
        
        .btn:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background-color: #6b7280;
        }
        
        .btn-secondary:hover {
            background-color: #4b5563;
        }
        
        .alert {
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
        }
        
        .alert-error {
            background-color: #fef2f2;
            border: 1px solid #fecaca;
            color: #991b1b;
        }
        
        .alert-success {
            background-color: #f0fdf4;
            border: 1px solid #bbf7d0;
            color: #166534;
        }
        
        .stats {
            background-color: white;
            padding: 1rem;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
            margin: 1rem 0;
        }
        
        .preview {
            background-color: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 1rem;
            margin: 1rem 0;
        }
        
        .preview pre {
            background-color: #f8fafc;
            padding: 1rem;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 0.8rem;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }
        
        .spinner {
            border: 2px solid #f3f4f6;
            border-radius: 50%;
            border-top: 2px solid #3b82f6;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div data-controller="excel-converter">
        <h1>Excel to JSON ë³€í™˜ê¸°</h1>
        <p style="color: #6b7280;">Excel íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ JSON í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•´ë“œë¦½ë‹ˆë‹¤. ë³‘í•©ëœ ì…€ë„ ìë™ìœ¼ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤.</p>
        
        <!-- íŒŒì¼ ì—…ë¡œë“œ ì˜ì—­ -->
        <div class="upload-area" 
             data-excel-converter-target="uploadArea"
             data-action="click->excel-converter#selectFile dragover->excel-converter#handleDragOver dragleave->excel-converter#handleDragLeave drop->excel-converter#handleDrop">
            <div>
                <svg width="48" height="48" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" style="color: #9ca3af; margin: 0 auto 1rem;">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5"/>
                </svg>
                <p><strong>í´ë¦­í•˜ì—¬ íŒŒì¼ ì—…ë¡œë“œ</strong> ë˜ëŠ” ë“œë˜ê·¸ ì•¤ ë“œë¡­</p>
                <p style="font-size: 0.8rem; color: #6b7280;">Excel íŒŒì¼ (.xlsx, .xls)</p>
            </div>
            <input type="file" 
                   class="file-input" 
                   accept=".xlsx,.xls"
                   data-excel-converter-target="fileInput"
                   data-action="change->excel-converter#handleFileSelect">
        </div>
        
        <!-- ë¡œë”© -->
        <div class="loading hidden" data-excel-converter-target="loading">
            <div class="spinner"></div>
            <span>íŒŒì¼ì„ ë³€í™˜í•˜ëŠ” ì¤‘...</span>
        </div>
        
        <!-- ì—ëŸ¬ ë©”ì‹œì§€ -->
        <div class="alert alert-error hidden" data-excel-converter-target="errorAlert">
            <strong>ì˜¤ë¥˜ ë°œìƒ:</strong> <span data-excel-converter-target="errorMessage"></span>
        </div>
        
        <!-- ì„±ê³µ ë©”ì‹œì§€ ë° í†µê³„ -->
        <div class="alert alert-success hidden" data-excel-converter-target="successAlert">
            <strong>ë³€í™˜ ì™„ë£Œ!</strong>
            <div class="stats">
                <p data-excel-converter-target="statsInfo"></p>
            </div>
        </div>
        
        <!-- ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ë“¤ -->
        <div class="hidden" data-excel-converter-target="downloadButtons">
            <button class="btn" data-action="click->excel-converter#downloadJson">
                ğŸ“¥ JSON íŒŒì¼ ë‹¤ìš´ë¡œë“œ
            </button>
            <button class="btn btn-secondary" data-action="click->excel-converter#copyToClipboard">
                ğŸ“‹ í´ë¦½ë³´ë“œì— ë³µì‚¬
            </button>
        </div>
        
        <!-- JSON ë¯¸ë¦¬ë³´ê¸° -->
        <div class="preview hidden" data-excel-converter-target="preview">
            <h3>JSON ë¯¸ë¦¬ë³´ê¸° (ì²˜ìŒ 3ê°œ í•­ëª©)</h3>
            <pre data-excel-converter-target="previewContent"></pre>
            <p style="color: #6b7280; font-size: 0.9rem;" data-excel-converter-target="previewNote"></p>
        </div>
    </div>

    <script>
        // Stimulus ì»¨íŠ¸ë¡¤ëŸ¬ ë“±ë¡
        const application = Stimulus.Application.start();
        
        application.register("excel-converter", class extends Stimulus.Controller {
            static targets = ["uploadArea", "fileInput", "loading", "errorAlert", "errorMessage", 
                            "successAlert", "statsInfo", "downloadButtons", "preview", 
                            "previewContent", "previewNote"];
            
            connect() {
                this.jsonData = null;
                this.fileName = null;
            }
            
            selectFile() {
                this.fileInputTarget.click();
            }
            
            handleDragOver(event) {
                event.preventDefault();
                this.uploadAreaTarget.classList.add('dragover');
            }
            
            handleDragLeave(event) {
                event.preventDefault();
                this.uploadAreaTarget.classList.remove('dragover');
            }
            
            handleDrop(event) {
                event.preventDefault();
                this.uploadAreaTarget.classList.remove('dragover');
                
                const files = event.dataTransfer.files;
                if (files.length > 0) {
                    this.processFile(files[0]);
                }
            }
            
            handleFileSelect(event) {
                const file = event.target.files[0];
                if (file) {
                    this.processFile(file);
                }
            }
            
            async processFile(file) {
                // íŒŒì¼ í™•ì¥ì ê²€ì‚¬
                const fileName = file.name.toLowerCase();
                if (!fileName.endsWith('.xlsx') && !fileName.endsWith('.xls')) {
                    this.showError('Excel íŒŒì¼(.xlsx, .xls)ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                    return;
                }
                
                this.fileName = file.name;
                this.hideMessages();
                this.showLoading(true);
                
                try {
                    // íŒŒì¼ì„ ArrayBufferë¡œ ì½ê¸°
                    const arrayBuffer = await file.arrayBuffer();
                    
                    // Excel íŒŒì¼ íŒŒì‹±
                    const workbook = XLSX.read(arrayBuffer, {
                        cellStyles: true,
                        cellFormulas: true,
                        cellDates: true,
                        sheetStubs: true
                    });
                    
                    // ì²« ë²ˆì§¸ ì‹œíŠ¸ ë˜ëŠ” "1" ì‹œíŠ¸ ì„ íƒ
                    let sheetName = workbook.SheetNames[0];
                    if (workbook.SheetNames.includes('1')) {
                        sheetName = '1';
                    }
                    
                    const sheet = workbook.Sheets[sheetName];
                    const rawData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                    
                    if (rawData.length === 0) {
                        throw new Error('ì‹œíŠ¸ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    }
                    
                    // í—¤ë”ì™€ ë°ì´í„° ë¶„ë¦¬
                    const headers = rawData[0];
                    const dataRows = rawData.slice(1);
                    
                    // ë³‘í•©ëœ ì…€ ì²˜ë¦¬
                    const merges = sheet['!merges'] || [];
                    const mergeMap = new Map();
                    
                    merges.forEach(merge => {
                        const startRow = merge.s.r;
                        const endRow = merge.e.r;
                        const startCol = merge.s.c;
                        const endCol = merge.e.c;
                        const firstCellValue = rawData[startRow] && rawData[startRow][startCol];
                        
                        for (let r = startRow; r <= endRow; r++) {
                            for (let c = startCol; c <= endCol; c++) {
                                mergeMap.set(`${r},${c}`, firstCellValue);
                            }
                        }
                    });
                    
                    // JSON ë°ì´í„° ìƒì„±
                    const jsonResult = [];
                    dataRows.forEach((row, rowIndex) => {
                        const actualRowIndex = rowIndex + 1;
                        const obj = {};
                        let hasData = false;
                        
                        headers.forEach((header, colIndex) => {
                            let value = row[colIndex];
                            
                            // ë³‘í•©ëœ ì…€ ê°’ ì ìš©
                            const mergeKey = `${actualRowIndex},${colIndex}`;
                            if (mergeMap.has(mergeKey)) {
                                value = mergeMap.get(mergeKey);
                            }
                            
                            if (value !== undefined && value !== null && value !== '') {
                                obj[header] = value;
                                hasData = true;
                            }
                        });
                        
                        if (hasData) {
                            jsonResult.push(obj);
                        }
                    });
                    
                    this.jsonData = jsonResult;
                    
                    // ì„±ê³µ ë©”ì‹œì§€ì™€ í†µê³„ í‘œì‹œ
                    this.showSuccess({
                        sheetName: sheetName,
                        originalRows: rawData.length - 1,
                        processedRows: jsonResult.length,
                        columns: headers.length,
                        mergedCells: merges.length
                    });
                    
                    this.showPreview();
                    
                } catch (error) {
                    this.showError(`íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
                } finally {
                    this.showLoading(false);
                }
            }
            
            showLoading(show) {
                this.loadingTarget.classList.toggle('hidden', !show);
            }
            
            hideMessages() {
                this.errorAlertTarget.classList.add('hidden');
                this.successAlertTarget.classList.add('hidden');
                this.downloadButtonsTarget.classList.add('hidden');
                this.previewTarget.classList.add('hidden');
            }
            
            showError(message) {
                this.errorMessageTarget.textContent = message;
                this.errorAlertTarget.classList.remove('hidden');
            }
            
            showSuccess(stats) {
                this.statsInfoTarget.innerHTML = `
                    â€¢ ì‹œíŠ¸: ${stats.sheetName}<br>
                    â€¢ ì´ ${stats.originalRows}í–‰ â†’ ${stats.processedRows}ê°œ ê°ì²´ë¡œ ë³€í™˜<br>
                    â€¢ ì»¬ëŸ¼ ìˆ˜: ${stats.columns}ê°œ<br>
                    â€¢ ë³‘í•©ëœ ì…€: ${stats.mergedCells}ê°œ (ìë™ ì²˜ë¦¬ë¨)
                `;
                this.successAlertTarget.classList.remove('hidden');
                this.downloadButtonsTarget.classList.remove('hidden');
            }
            
            showPreview() {
                if (!this.jsonData) return;
                
                const previewData = this.jsonData.slice(0, 3);
                this.previewContentTarget.textContent = JSON.stringify(previewData, null, 2);
                
                if (this.jsonData.length > 3) {
                    this.previewNoteTarget.textContent = `... ì´ ${this.jsonData.length}ê°œ í•­ëª© (ì „ì²´ ë‚´ìš©ì€ ë‹¤ìš´ë¡œë“œí•´ì„œ í™•ì¸í•˜ì„¸ìš”)`;
                } else {
                    this.previewNoteTarget.textContent = '';
                }
                
                this.previewTarget.classList.remove('hidden');
            }
            
            downloadJson() {
                if (!this.jsonData) return;
                
                const jsonString = JSON.stringify(this.jsonData, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = this.fileName ? this.fileName.replace(/\.(xlsx?|xls)$/i, '.json') : 'converted.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
            
            async copyToClipboard() {
                if (!this.jsonData) return;
                
                try {
                    await navigator.clipboard.writeText(JSON.stringify(this.jsonData, null, 2));
                    alert('JSON ë°ì´í„°ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
                } catch (error) {
                    alert('í´ë¦½ë³´ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            }
        });
    </script>
</body>
</html>